"use strict";

const { execFile } = require("@roeybiran/task");
const CacheConf = require("cache-conf");

const cache = new CacheConf();

/**
 * Convert POSIX paths to AppleScript-escaped HFS paths
 * @param {string|string[]} file - a POSIX path to a file.
 * @returns {string[]} - the file's HFS path.
 */
module.exports = async filePaths => {
  let paths;

  if (typeof filePaths === "string") {
    paths = [filePaths];
  } else {
    paths = filePaths;
  }

  const output = [];
  let startupDisk = cache.get("startupDisk");
  if (!startupDisk) {
    startupDisk = await execFile(
      "/usr/bin/osascript",
      "-e",
      'tell application "System Events" to get name of startup disk'
    );
    cache.set("startupDisk", startupDisk);
  }

  paths.forEach(aPath => {
    // replace first / with the name of the startup disk
    let composedPath = startupDisk + aPath;
    // replace : with / and with versa, and escape "
    composedPath = composedPath
      .replace(/\/|:/g, aString => (aString === ":" ? "/" : ":"))
      .replace(/"/g, '\\"');
    output.push(composedPath);
  });
  return output;
};
