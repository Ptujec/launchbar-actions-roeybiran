"use strict";

const lbCache = require("@roeybiran/launchbar-cache");
const got = require("got");

/**
 * perfrom HTTP requests.
 */
module.exports = (url, options) => {
  options = Object.assign(
    {
      json: true
    },
    options
  );

  if (typeof url !== "string") {
    return Promise.reject(
      new TypeError(
        `Expected \`url\` to be a \`string\`, got \`${typeof url}\``
      )
    );
  }
  if (options.transform && typeof options.transform !== "function") {
    return Promise.reject(
      new TypeError(
        `Expected \`transform\` to be a \`function\`, got \`${typeof options.transform}\``
      )
    );
  }

  const rawKey = url + JSON.stringify(options);
  const key = rawKey.replace(/\./g, "\\.");

  const cachedResponse = lbCache.get(key, { ignoreMaxAge: true });
  if (cachedResponse && !lbCache.isExpired(key)) {
    return Promise.resolve(cachedResponse);
  }

  return got(url, options)
    .then(response =>
      options.transform ? options.transform(response.body) : response.body
    )
    .then(data => {
      if (options.maxAge) {
        lbCache.set(key, data, { maxAge: options.maxAge });
      }
      return data;
    })
    .catch(error => {
      if (cachedResponse) {
        return cachedResponse;
      }
      throw error;
    });
};
