"use strict";

const { execFile } = require("@roeybiran/task");

/**
 * Asks for user input. Returns 'false` if the user cancelled.
 * @param {Object} options
 * @param {String} options.text - to be displayed in the dialog's Body.
 * @param {String=} options.title - the dialog's title.
 * @param {Boolean=} options.hiddenAnswer
 * @param {Array<String>=} options.buttons - an array of strings. Must be between 1 and 3 items.
 * @param {String=} options.defaultButton
 * @param {String=} options.cancelButton
 * @param {Number=} options.givingUpAfter
 * @param {String=} options.withApp - `tell` an application to display the dialog.
 * @returns {Promise<String|Boolean>}
 */
module.exports = async options => {
  try {
    const { text } = options;
    const defaultAnswer = options.defaultAnswer || "";
    const title = options.title || "";
    const hiddenAnswer = options.hiddenAnswer || false;
    const defaultButton = options.defaultButton || "OK";
    const cancelButton = options.cancelButton || "Cancel";
    const givingUpAfter = options.givingUpAfter || 0;

    let buttons = options.buttons || '"Cancel", "OK"';
    if (options.buttons) {
      buttons = buttons
        .map(x => {
          return `"${x}"`;
        })
        .join(", ");
    }

    let icon = "";
    if (options.icon) {
      icon = `with icon "${options.icon}"`;
    }

    let withApp = "";
    if (options.withApp) {
      withApp = `tell application "${options.withApp}" to`;
    }

    const script = `
      try
        ${withApp} set theDialog to display dialog "${text}" default answer "${defaultAnswer}" with title "${title}" buttons {${buttons}} default button "${defaultButton}" cancel button "${cancelButton}" hidden answer ${hiddenAnswer} ${icon} giving up after ${givingUpAfter}
        set buttonReturned to text returned of theDialog
      on error number -128
        error number -128
      end try
      `;
    const { stdout } = await execFile("/usr/bin/osascript", ["-e", script]);
    return stdout;
  } catch (error) {
    if (error.stderr.trim().endsWith("User canceled. (-128)")) {
      return false;
    }
    throw error;
  }
};
