"use strict";

const path = require("path");
const { execFile } = require("@roeybiran/task");

/**
 * @param {Object=} options
 * @param {String=} options.prompt
 * @param {String=} options.defaultLocation
 * @param {Boolean=} options.showInvisibles
 * @param {Boolean=} options.multiSelectionsAllowed
 * @param {Boolean=} options.showingPackageContents
 * @param {String=} options.withApp
 * @returns {String} the POSIX path of the chosen folder
 */
module.exports = async options => {
  let prompt = "";
  let defaultLocation = path.join(process.env.HOME, "Desktop");
  let showInvisibles = true;
  let multiSelectionsAllowed = true;
  let showingPackageContents = false;
  let withApp = "";

  if (options) {
    if (options.prompt) {
      prompt = options.prompt;
    }
    if (options.defaultLocation) {
      defaultLocation = options.defaultLocation;
    }

    if (options.showInvisibles !== undefined) {
      showInvisibles = options.showInvisibles;
    }

    if (options.multiSelectionsAllowed !== undefined) {
      multiSelectionsAllowed = options.multiSelectionsAllowed;
    }

    if (options.showingPackageContents !== undefined) {
      showingPackageContents = options.showingPackageContents;
    }

    if (options.withApp) {
      withApp = `tell application "${options.withApp}" to `;
    }
  }

  const script = `${withApp} set theDialog to choose folder with prompt "${prompt}" ¬
	default location "${defaultLocation}" ¬
	invisibles ${showInvisibles} ¬
	multiple selections allowed ${multiSelectionsAllowed} ¬
  showing package contents ${showingPackageContents}
  return POSIX path of theDialog`;

  try {
    const { stdout } = await execFile("/usr/bin/osascript", ["-e", script]);
    return stdout;
  } catch (error) {
    if (error.message.trim().endsWith("(-128)")) {
      return false;
    }
    throw error;
  }
};
